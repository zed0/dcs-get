#!/var/tmp/dcs-get/bin/node-0.4.2

//This is the dcs-get command line client.

var dcsGet = require( "./dcs-get-api" );
var tty = require('tty');

if (process.argv[2] === undefined) {
	console.log("Try dcs-get help");
	return;
}
else {
	switch (process.argv[2]) {
		case "list":
		case "l":
			dcsGet.listPackages();
			break;
		case "list-dev":
		case "ld":
			dcsGet.listPackagesDev();
			break;
		case "clean":
		case "c":
			dcsGet.clean();
			break;
		case "search":
		case "s":
			dcsGet.search( process.argv[3] );
			break;
		case "install":
		case "i":
			process.argv.shift();
			process.argv.shift();
			process.argv.shift();
			dcsGet.install( process.argv );
			var id = setInterval(function drawProgress() {
				dcsGet.listDownloading(function(err, packageList) {
					if (err) {
						console.log(err);
						clearInterval( id );
					}
					else {
						var n = 0;
						var totalPackageDownloaded = 0;
						var totalPackageSize = 0;
						//var termWidth = console.log(process.env['COLUMNS']);
						//var termHeight = console.log(process.env['LINES']);
						var termWidth = 50;
						var termHeight = 100;

						for(package in packageList) {
							n++;
							totalPackageDownloaded += packageList[package].downloaded;
							totalPackageSize += packageList[package].totalSize;

							var fracDone = packageList[package].downloaded/packageList[package].totalSize;

							process.stdout.write("\033[K" + package + ": " + fracDone*100 + "%\n");
							process.stdout.write("\033[K[");
							for (var i=0; i<(fracDone*(termWidth-2)); i++) {
								process.stdout.write('=');
							}
							for (var i=0; i<((1-fracDone)*(termWidth-2)); i++) {
								process.stdout.write(' ');
							}
							process.stdout.write("]\n");
						}
						if (n) {
							var totalFracDone = totalPackageDownloaded/totalPackageSize;
							process.stdout.write("\033[KTotal: " + (totalPackageDownloaded/totalPackageSize)*100 + "%\n\033[K");
							process.stdout.write("\033[K[");
							for (var i=0; i<(totalFracDone*(termWidth-2)); i++) {
								process.stdout.write('=');
							}
							for (var i=0; i<((1-totalFracDone)*(termWidth-2)); i++) {
								process.stdout.write(' ');
							}
							process.stdout.write("]\n\033[K\n\033[K");
							process.stdout.write("\033[" + (2*n+3) + "A");
						} else {
							clearInterval(id);
						}
					}
				});
			}, 500 );
			break;
		case "reinstall":
		case "r":
			process.argv.shift();
			process.argv.shift();
			process.argv.shift();
			dcsGet.reinstall( process.argv );
			break;			
		case "list-downloading":
			dcsGet.listDownloading( function( err, packageName, downloaded, totalSize) {
				if ( !err ) {
					process.stdout.write( packageName + ": " + (downloaded/totalSize)*100 + "%\n");
				}
			});
			break;
		case "list-installed":
		case "li":
			dcsGet.listInstalled();
			break;
		case "gensymlinks":
		case "g":
			process.argv.shift();
			process.argv.shift();
			process.argv.shift();
			dcsGet.genSymlinks( process.argv );
			break;
		case "package":
		case "p":
			process.argv.shift();
			process.argv.shift();
			process.argv.shift();
			dcsGet.package( process.argv );
			break;
		case "upload":
		case "u":
			process.argv.shift();
			process.argv.shift();
			process.argv.shift();
			dcsGet.upload( process.argv );
			break;
		case "help":
			dcsGet.help();
			break;
		case "commands":
			console.log("commands search install reinstall list list-dev clean gensymlinks package help upload");
			break;
		default:
			console.log("Try dcs-get help");
	}	
}
